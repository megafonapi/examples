<html>
<head>
<title>Megafon.API Example</title>
</head>
<body>
	<script type="text/javascript" src='jsonrpcws.js'></script>
	<script type="text/javascript">
	if (window.WebSocket) {
		window.onload = () => {
			let cf = null;
			connection.onclick = () => {
				if (connection.innerText == 'Connect') {
					const protocol = location.protocol.replace('http', 'ws');
					client = new JsonRpcWs(`${protocol}//${login.value}:${password.value}@${location.host}/v1/api`);
					client.handle('OnOpen', () => {
						connection.innerText = 'Disconnect';
						actions.style.display = 'block';
					});
					client.handle('OnAnswerCall', (params) => {
						if (params.call_session) {
							client.request('PlayAnnouncement', { call_session: params.call_session, filename: 'welcome.pcm' });
						}
					});
					client.handle('OnPlayAnnouncement', (params) => {
						if (cf && cf.data && cf.data.conf_session) {
							client.request('AddToConf', { conf_session: cf.data.conf_session, call_session: params.call_session });
						} else {
							client.request('TerminateCall', { call_session: params.call_session });
						}
					});
					client.handle('OnIncomingCall', (params) => {
						if (params.call_session) {
							client.request('AnswerCall', { call_session: params.call_session });
						}
					});
					client.handle('OnTerminateCall', () => {
						console.log('call terminated');
					});
					client.handle('OnClose', () => {
						connection.innerText = 'Connect';
						actions.style.display = 'none';
					});
					client.open();
				} else {
					client.close();
				}
			}
			call.onclick = () => {
				client.request('MakeCall', { bnum: destination.value });
			}
			conference.onclick = () => {
				if (cf == null)
					cf = client.request('CreateConf');
				if (cf && cf.data && cf.data.conf_session) {
					client.request('MakeCall', { bnum: destination.value });
				}
			}
		}
	} else {
		console.log('Your browser does not support websockets and promises');
	}
	</script>
	<input id='login' placeholder='Login'>
	<input id='password' placeholder='Password'>
	<button id='connection'>Connect</button>
	<br><br>
	<div id='actions' style='display:none'>
	<input id='destination' placeholder='Destination'>
	<button id='call'>Call</button>
	<button id='conference'>Conference</button>
	</div>
</body>
</html>