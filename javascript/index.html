<html>
<head>
<title>Megafon.API Example</title>
</head>
<body>
	<script type="text/javascript" src='jsonrpcws.js'></script>
	<script type="text/javascript">
	if (window.WebSocket && window.Promise) {
		window.onload = () => {
			let cf = null
			connection.onclick = async () => {
				if (connection.innerText == 'Connect') {
					client = new JsonRpcWs(`ws://${login.value}:${password.value}@${location.host}/v1/api`);
					client.handle('OnOpen', async () => {
						connection.innerText = 'Disconnect';
						actions.style.display = 'block';
					})
					client.handle('OnAnswerCall', async (params) => {
						if (params.call_session) {
							await client.request('PlayAnnouncement', { call_session: params.call_session, filename: 'welcome.pcm' });
						}
					});
					client.handle('OnPlayAnnouncement', async (params) => {
						if (cf && cf.data && cf.data.conf_session) {
							await client.request('AddToConf', { conf_session: cf.data.conf_session, call_session: params.call_session });
						} else {
							await client.request('TerminateCall', { call_session: params.call_session });
						}
					});
					client.handle('OnIncomingCall', async (params) => {
						if (params.call_session) {
							await client.request('AnswerCall', { call_session: params.call_session });
						}
					});
					client.handle('OnTerminateCall', async (params) => {
						console.log('call terminated');
					});
					client.handle('OnClose', async () => {
						connection.innerText = 'Connect';
						actions.style.display = 'none';
					})
					await client.open();
				} else {
					await client.close();
				}
			}
			call.onclick = async () => {
				const response = await client.request('MakeCall', { bnum: destination.value });
				console.log({ 'MakeCall response': response });
			}
			conference.onclick = async () => {
				if (cf == null)
					cf = await client.request('CreateConf');
				if (cf && cf.data && cf.data.conf_session) {
					await client.request('MakeCall', { bnum: destination.value });
				}
			}
		}
	} else {
		console.log('Your browser does not support websockets and promises');
	}
	</script>
	<input id='login' placeholder='Login'>
	<input id='password' placeholder='Password'>
	<button id='connection'>Connect</button>
	<br><br>
	<div id='actions' style='display:none'>
	<input id='destination' placeholder='Destination'>
	<button id='call'>Call</button>
	<button id='conference'>Conference</button>
	</div>
</body>
</html>